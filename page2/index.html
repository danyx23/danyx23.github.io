<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Daniel Bachler</title>
  <meta name="description" content="The personal website of Daniel Bachler - Software Engineer and Photographer
">

  <script src="https://kit.fontawesome.com/98871ddfec.js" crossorigin="anonymous"></script>

  <!-- Load up MathJax script if needed ... specify in /_data/options.yml file-->
  
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  

  <link rel="stylesheet" href="https://use.typekit.net/hil6otl.css">
  <link rel="stylesheet" type="text/css" href="/css/tufte.css">

  <!-- <link rel="stylesheet" href="/css/main.css"> -->
  <link rel="canonical" href="http://danielbachler.de/page2/">
  <link rel="alternate" type="application/rss+xml" title="Daniel Bachler" href="http://danielbachler.de/feed.xml">
    <script>
        (function(d) {
            var config = {
                        kitId: 'hil6otl',
                        scriptTimeout: 3000,
                        async: true
                    },
                    h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
        })(document);
    </script>
  <script src="/js/modernizr-custom.js"></script>

</head>


<body>

<header class="site-header">


  <nav class="site-nav site-header">
    <div class="nav-inner">
      <a class="site-title" href="/">DANIELBACHLER.DE</a>
      <!--
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      -->
      <div class="trigger">
        <a class="page-link" href="/">Blog</a>
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/cv.html">CV</a>
          
        
          
          <a class="page-link" href="/about.html">About me</a>
          
        
      </div>
    </div>
    </nav>

</header>


<article class="group">
  <div class="home">

    <!-- This loops through the paginated posts -->
    
    <article>
        <h1><a href="/2016/12/10/f-sharp-on-the-frontend-and-the-backend.html">Using F# on both the frontend and the backend</a></h1>
        <p class="author">
          <span class="date">10 December 2016</span>
        </p>
        <div class="content">
          <p><em>Note: This post was written in 2016. Since then, the introduction of the <a href="https://safe-stack.github.io/">SAFE stack</a> has significantly improved the sitation in F#, but the basic ideas of this blog post are still valid - they are just a lot nicer now :)</em></p>

<p>When the call for the <a href="https://sergeytihon.wordpress.com/tag/fsadvent/">F# Advent Calendar</a> came up I thought that this would be a great opportunity to finally check out a technology stack that intrigued me for quite a while now: Using F# on the backend (which by now works well on linux/osx as well as windows) and also on the frontend, via <a href="http://fable.io/">Fable</a>, the F# to Javascript compiler backend. I have played a bit with F# in the past but I wanted to see how well this particular combination works in practice.</p>

<h3 id="the-same-language-on-the-backend-and-the-frontend">The same language on the backend and the frontend</h3>

<p>Using the same language on the server and the client has many benefits in my opinion, chief among them the ability to reuse data definitions and business logic. Even though many modern web sites shoulder a lot of complexity on the client to guide the user and give immediate feedback, the backend usually has to replicate most of this logic to verify the client submissions and guard against malicious clients. Discount rules are a prime example of such code that is often replicated in both the frontend and the backend.</p>

<p>The first language that will probably come to mind for this job is Javascript. Since the advent of Node, Javascript is available on the backend as well as in the browser, and, with Electron, even for desktop apps with a native feel. Heavy performance tuning has made Javascript reasonably fast. However, I think that its dynamically typed nature makes Javascript a very problematic choice for non-trivial software projects. Static type checking can catch many bugs before they ever hit production and it can free your developers to concentrate on testing the properties of their code that are actually interesting.</p>

<p>A very desirable property for a type system is for it to have Algebraic Data Types. This means that, in addition to Product types (think classes or records) where ALL stated fields exist for every instance, they also support Sum types (Discriminated Unions in F#) where every value adheres to exactly one of several strictly predefined layouts. Together, Product and Sum types allow a much richer modelling where you can make illegal states irrepresentable (see this <a href="http://blog.ploeh.dk/2016/11/28/easy-domain-modelling-with-types/">recent article by Marc Seemann</a> on the benefits of ADTs). Having Sum types also allows languages to get rid of nulls - a very desirable trait since a big fraction of errors in dynamically typed languages or such with weak type systems are NullReferenceExceptions or the infamous “undefined is not a function”.</p>

<h3 id="possible-languages">Possible languages</h3>

<p>Ok, now that I have outlined desirable feature, let us look for languages that meet these two core requirements (a strong, static type system with ADTs and being usable via cross-compilation to Javascript on both the browser frontend and the backend). Not a lot of options remain. The ones I know are:</p>

<ul>
  <li><a href="https://www.typescriptlang.org/">Typescript</a></li>
  <li><a href="http://www.purescript.org/">Purescript</a></li>
  <li><a href="http://fable.io/">F#/Fable</a></li>
  <li><a href="http://bloomberg.github.io/bucklescript/">OCaml/Bucklescript</a></li>
  <li><a href="https://github.com/ghcjs/ghcjs">Haskell/ghcjs</a></li>
</ul>

<p>All of these are interesting languages. Here is my very personal reasoning for choosing among these languages: Typescript is a superset of Javascript with type annotations that, since version 2.0, has support for union types. It is a big improvement over raw Javascript, but I think that one still feels a lot of the odd language design decisions underneath it, so I will disregard it for now.</p>

<p>The javascript compiler backends for OCaml and Haskell have a relatively small set of Javascript library bindings available and are IMHO harder to interface with native Javascript libraries - for now I don’t think that they are immediately usable if you want to write user interfaces with them.</p>

<p>This leaves me with F#/Fable and Purescript. Purescript was designed from the beginning with Javascript as the compile target in mind. Quite a few important Javascript libraries have been annotated with type definitions for Purescript and are thus readily usable, and if they are not, the Purescript FFI was built for Javascript and is very straightforward to use. Additionally, the type system of Purescript is very powerful and feels a bit like a modern refresh of Haskell’s type system.</p>

<p>So what about F#/Fable? The basic story is similar to OCaml/Haskell in that you have to create FFI definitions and these are only available for a few libraries so far. What is really neat about Fable though is that there is a way to bootstrap Fable FFI files from Typescript definitions via <a href="https://www.npmjs.com/package/ts2fable">ts2fable</a> - and those are available for a huge number of important Javascript libraries. I think that this lowers the pain of interfacing with native Javascript libraries enough for F#/Fable to be a reasonable choice.</p>

<h3 id="f-versus-purescript">F# versus Purescript</h3>

<p>Purescript is definitely an interesting contender that I want to study more in the future, but this blog post is about F#, so, let us ask the obvious question: why use F# instead of Purescript? YMMV but I see F# to have an interesting advantage on the server side since IMO on the backend the .NET platform is a more solid runtime than Node. Since F# compiles to IL and can interface with any .NET library, it has access to a huge amount of libraries that interface with all sorts of systems, parse files etc. It also supports strong multi-threading primitives and F# even has support to cross compile to the GPU - this makes it much more interesting for numerically intense workloads than Node.</p>

<p>This means that if you either already have a big chunk of business logic written in a .NET language or if you need to do high performance computations on the server, F# is IMO a more attractive choice than Purescript. Additionally, because F# is more in the tradition of pragmatic functional languages like OCaml than the Haskell tradition of that Purescript adopted, it offers the escape hatches of mutability and side effects within the normal control flow (this is arguably also dangerous, but debating this is for another post).</p>

<p>The downside of F#/Fable is that the same language is bolted onto two different runtimes with slightly different semantics. One example of such a mismatch is that the fixed-point arithmetic datatype Decimal of the .NET platform does not exist in Javascript of course and is thus silently converted to a double. For many cases this is fine but it is definitely something to be aware of (<a href="http://fable.io/docs/compatibility.html">a longer list is here</a> )</p>

<p>Alright, so this is why I think it makes sense to use the same language on the backend and frontend, some of my criteria for choosing a language and why F# is the candidate I want to use.</p>

<h3 id="the-proof-of-concept-idea">The proof of concept idea</h3>

<p>Let’s finally get to some <a href="https://github.com/danyx23/FableSuaveSharedCode">code</a>! Be warned that some of this is probably not exactly idiomatic F# code since I haven’t used the language much until now :)</p>

<p>The basic idea for my little proof of concept was:</p>

<ul>
  <li>Write a frontend in F# that is the most primitive shopping cart you can imagine - it just has one product and the user can use buttons to increase/decrease the quantity.</li>
  <li>Have a type that defines a discount, consisting of: a name, a function that checks whether the discount applies and one that modifies the price. Reuse these data types and functions between the frontend and the backend</li>
  <li>On the frontend, use <a href="https://github.com/fable-compiler/fable-arch">Fable-Arch</a> to bring the clarity of the <a href="https://guide.elm-lang.org/architecture/">Elm Architecture</a> to F#</li>
  <li>Bundle up the generated Javascript into an Electron app to see how well this works</li>
  <li>Since the Electron Desktop app is based on the Chromium engine, use the power of CSS and icon fonts to pep up the UI a little by just dropping in some CSS from a third party.</li>
  <li>Try <a href="http://suave.io">Suave</a> as a http server with a functional design. Reuse the type definitions and discount calculation code. Handle Json-Serialization and CORS headers.</li>
</ul>

<h3 id="the-implementation">The implementation</h3>

<p>The entire setup is on github at <a href="https://github.com/danyx23/FableSuaveSharedCode">https://github.com/danyx23/FableSuaveSharedCode</a> where you can just clone it and run both the Suave server and the electron based client.</p>

<p>Since this is a proof of concept, the actual code is maybe less interesting than the setup around it, but for completness sake, what follows are the three main file that are the essence of the two programs. First, the shared code that defines the Cart and Discount types, a concrete instance of the Discount type that gives a 90% discount at twelve items and the function to calculate the price for a cart given a list of potentially applicable discounts</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nc">DiscountSample</span>

<span class="k">module</span> <span class="nc">Shared</span> <span class="p">=</span>

  <span class="k">let</span> <span class="nc">ItemPrice</span> <span class="p">=</span> <span class="mi">20</span><span class="p">.</span><span class="mi">0</span>

  <span class="k">type</span> <span class="nc">Cart</span> <span class="p">=</span>
    <span class="p">{</span> <span class="nc">Quantity</span><span class="p">:</span> <span class="kt">int</span>
    <span class="p">}</span>

  <span class="k">type</span> <span class="nc">Discount</span> <span class="p">=</span>
    <span class="p">{</span> <span class="nc">Name</span><span class="p">:</span> <span class="kt">string</span>
      <span class="nc">Applies</span><span class="p">:</span> <span class="p">(</span><span class="nc">Cart</span> <span class="p">-&gt;</span> <span class="kt">bool</span><span class="p">)</span>
      <span class="nc">ApplyDiscount</span><span class="p">:</span> <span class="p">(</span><span class="n">double</span> <span class="p">-&gt;</span> <span class="n">double</span><span class="p">)</span>
    <span class="p">}</span>

  <span class="k">let</span> <span class="n">doesTwelveItemsDiscountApply</span> <span class="n">cart</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">cart</span><span class="p">.</span><span class="nc">Quantity</span> <span class="k">with</span>
    <span class="p">|</span> <span class="mi">12</span> <span class="p">-&gt;</span> <span class="bp">true</span>
    <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="bp">false</span>


  <span class="k">let</span> <span class="n">twelveItemsDiscount</span> <span class="p">=</span>
    <span class="p">{</span> <span class="nc">Name</span> <span class="p">=</span> <span class="s2">"12 Items - 90% off!"</span>
      <span class="nc">Applies</span> <span class="p">=</span> <span class="n">doesTwelveItemsDiscountApply</span>
      <span class="nc">ApplyDiscount</span> <span class="p">=</span> <span class="p">(</span><span class="k">fun</span> <span class="n">price</span> <span class="p">-&gt;</span> <span class="n">price</span> <span class="p">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>

  <span class="k">let</span> <span class="n">calculatePrice</span> <span class="p">(</span><span class="n">discounts</span> <span class="p">:</span> <span class="nc">Discount</span> <span class="kt">list</span><span class="p">)</span> <span class="p">(</span><span class="n">cart</span> <span class="p">:</span> <span class="nc">Cart</span><span class="p">)</span> <span class="p">:</span> <span class="n">double</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">discountsThatApply</span> <span class="p">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">discount</span> <span class="p">-&gt;</span> <span class="n">discount</span><span class="p">.</span><span class="nc">Applies</span> <span class="n">cart</span><span class="p">)</span> <span class="n">discounts</span>
    <span class="k">let</span> <span class="n">cartCalculationFunction</span> <span class="p">=</span>
      <span class="k">match</span> <span class="n">discountsThatApply</span> <span class="k">with</span>
      <span class="p">|</span> <span class="bp">[]</span> <span class="p">-&gt;</span> <span class="n">id</span>
      <span class="p">|</span> <span class="n">x</span> <span class="p">::</span> <span class="n">xs</span> <span class="p">-&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nc">ApplyDiscount</span> <span class="c1">// use the first discount that applies only, discard the others</span>
    <span class="k">let</span> <span class="n">undiscountedPrice</span> <span class="p">=</span> <span class="p">(</span><span class="n">double</span> <span class="n">cart</span><span class="p">.</span><span class="nc">Quantity</span><span class="p">)</span> <span class="p">*</span> <span class="nc">ItemPrice</span>
    <span class="n">cartCalculationFunction</span> <span class="n">undiscountedPrice</span>
</code></pre></div></div>

<p>This shared code is then used in the frontend:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">#</span><span class="n">r</span> <span class="s2">"../node_modules/fable-core/Fable.Core.dll"</span>
<span class="p">#</span><span class="n">load</span> <span class="s2">"../node_modules/fable-arch/Fable.Arch.Html.fs"</span>
<span class="p">#</span><span class="n">load</span> <span class="s2">"../node_modules/fable-arch/Fable.Arch.App.fs"</span>
<span class="p">#</span><span class="n">load</span> <span class="s2">"../node_modules/fable-arch/Fable.Arch.Virtualdom.fs"</span>
<span class="p">#</span><span class="n">load</span> <span class="s2">"../../backend/src/ClientServerShared.fs"</span>
<span class="p">#</span><span class="n">r</span> <span class="s2">"../node_modules/fable-powerpack/Fable.PowerPack.dll"</span>


<span class="k">open</span> <span class="nn">Fable</span><span class="p">.</span><span class="nc">Core</span>
<span class="k">open</span> <span class="nn">Fable</span><span class="p">.</span><span class="nn">Core</span><span class="p">.</span><span class="nc">JsInterop</span>
<span class="k">open</span> <span class="nn">Fable</span><span class="p">.</span><span class="nn">Import</span><span class="p">.</span><span class="nc">Browser</span>

<span class="k">open</span> <span class="nn">Fable</span><span class="p">.</span><span class="nc">Arch</span>
<span class="k">open</span> <span class="nn">Fable</span><span class="p">.</span><span class="nn">Arch</span><span class="p">.</span><span class="nc">App</span>
<span class="k">open</span> <span class="nn">Fable</span><span class="p">.</span><span class="nn">Arch</span><span class="p">.</span><span class="nc">Html</span>
<span class="k">open</span> <span class="nn">DiscountSample</span><span class="p">.</span><span class="nc">Shared</span>
<span class="k">open</span> <span class="nn">Fable</span><span class="p">.</span><span class="nc">PowerPack</span>

<span class="k">type</span> <span class="nc">Status</span> <span class="p">=</span>
  <span class="p">|</span> <span class="nc">Shopping</span>
  <span class="p">|</span> <span class="nc">TransactionPending</span>
  <span class="p">|</span> <span class="nc">BuyingFailed</span> <span class="k">of</span> <span class="kt">string</span>
  <span class="p">|</span> <span class="nc">BuyingSucceeded</span> <span class="k">of</span> <span class="n">double</span>

<span class="k">type</span> <span class="nc">Model</span> <span class="p">=</span>
  <span class="p">{</span> <span class="nc">Cart</span><span class="p">:</span> <span class="nc">Cart</span>
    <span class="nc">Status</span><span class="p">:</span> <span class="nc">Status</span>
  <span class="p">}</span>

<span class="k">let</span> <span class="n">initModel</span> <span class="p">=</span>
  <span class="p">{</span> <span class="nc">Cart</span> <span class="p">=</span> <span class="p">{</span> <span class="nc">Quantity</span> <span class="p">=</span> <span class="mi">0</span> <span class="p">}</span>
    <span class="nc">Status</span> <span class="p">=</span> <span class="nc">Shopping</span>
  <span class="p">}</span>

<span class="k">type</span> <span class="nc">Actions</span> <span class="p">=</span>
  <span class="p">|</span> <span class="nc">IncreaseQuantity</span>
  <span class="p">|</span> <span class="nc">DecreaseQuantity</span>
  <span class="p">|</span> <span class="nc">Buy</span>
  <span class="p">|</span> <span class="nc">ServerResponseOk</span> <span class="k">of</span> <span class="n">double</span>
  <span class="p">|</span> <span class="nc">ServerResponseError</span> <span class="k">of</span> <span class="kt">string</span>
  <span class="p">|</span> <span class="nc">SetStatus</span> <span class="k">of</span> <span class="nc">Status</span>


<span class="c1">// Update</span>
<span class="k">let</span> <span class="n">update</span> <span class="n">model</span> <span class="n">action</span> <span class="p">=</span>
  <span class="k">let</span> <span class="n">model'</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">action</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">IncreaseQuantity</span> <span class="p">-&gt;</span>
      <span class="p">{</span> <span class="n">model</span> <span class="k">with</span> <span class="nc">Cart</span> <span class="p">=</span> <span class="p">{</span> <span class="n">model</span><span class="p">.</span><span class="nc">Cart</span> <span class="k">with</span> <span class="nc">Quantity</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="nn">Cart</span><span class="p">.</span><span class="nc">Quantity</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span>
    <span class="p">|</span> <span class="nc">DecreaseQuantity</span> <span class="p">-&gt;</span>
      <span class="p">{</span> <span class="n">model</span> <span class="k">with</span> <span class="nc">Cart</span> <span class="p">=</span> <span class="p">{</span> <span class="n">model</span><span class="p">.</span><span class="nc">Cart</span> <span class="k">with</span> <span class="nc">Quantity</span> <span class="p">=</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Math</span><span class="p">.</span><span class="nc">Max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="nn">Cart</span><span class="p">.</span><span class="nc">Quantity</span> <span class="p">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
    <span class="p">|</span> <span class="nc">SetStatus</span> <span class="n">status</span> <span class="p">-&gt;</span>
      <span class="p">{</span> <span class="n">model</span> <span class="k">with</span> <span class="nc">Status</span> <span class="p">=</span> <span class="n">status</span> <span class="p">}</span>
    <span class="p">|</span> <span class="nc">Buy</span> <span class="p">-&gt;</span> <span class="n">model</span>
    <span class="p">|</span> <span class="nc">ServerResponseOk</span> <span class="n">price</span> <span class="p">-&gt;</span> <span class="p">{</span> <span class="n">model</span> <span class="k">with</span> <span class="nc">Status</span> <span class="p">=</span> <span class="nc">BuyingSucceeded</span> <span class="n">price</span> <span class="p">}</span>
    <span class="p">|</span> <span class="nc">ServerResponseError</span> <span class="n">error</span> <span class="p">-&gt;</span> <span class="p">{</span> <span class="n">model</span> <span class="k">with</span> <span class="nc">Status</span> <span class="p">=</span> <span class="nc">BuyingFailed</span> <span class="n">error</span> <span class="p">}</span>

  <span class="k">let</span> <span class="n">delayedCall</span> <span class="n">h</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">action</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Buy</span> <span class="p">-&gt;</span>
        <span class="k">let</span> <span class="n">promise</span> <span class="p">=</span> <span class="nn">Fable</span><span class="p">.</span><span class="nn">PowerPack</span><span class="p">.</span><span class="nn">Fetch</span><span class="p">.</span><span class="n">postRecord</span> <span class="s2">"http://127.0.0.1:8083/test"</span> <span class="n">model</span><span class="p">.</span><span class="nc">Cart</span> <span class="bp">[]</span>
                      <span class="p">|&gt;</span> <span class="nn">Fable</span><span class="p">.</span><span class="nn">PowerPack</span><span class="p">.</span><span class="nn">Promise</span><span class="p">.</span><span class="n">bind</span>
                          <span class="p">(</span><span class="k">fun</span> <span class="n">response</span> <span class="p">-&gt;</span>
                            <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">&lt;</span><span class="n">double</span><span class="o">&gt;()</span>
                          <span class="p">)</span>
                      <span class="p">|&gt;</span> <span class="nn">Fable</span><span class="p">.</span><span class="nn">PowerPack</span><span class="p">.</span><span class="nn">Promise</span><span class="p">.</span><span class="n">map</span>
                          <span class="p">(</span><span class="k">fun</span> <span class="n">price</span> <span class="p">-&gt;</span>
                            <span class="n">h</span> <span class="p">(</span><span class="nc">ServerResponseOk</span> <span class="n">price</span><span class="p">)</span>
                          <span class="p">)</span>
                      <span class="p">|&gt;</span> <span class="nn">Fable</span><span class="p">.</span><span class="nn">PowerPack</span><span class="p">.</span><span class="nn">Promise</span><span class="p">.</span><span class="n">catch</span>
                          <span class="p">(</span><span class="k">fun</span> <span class="n">err</span> <span class="p">-&gt;</span>
                            <span class="n">h</span> <span class="p">(</span><span class="nc">ServerResponseError</span> <span class="n">err</span><span class="p">.</span><span class="nc">Message</span><span class="p">)</span>
                          <span class="p">)</span>

        <span class="n">h</span> <span class="p">(</span><span class="nc">SetStatus</span> <span class="nc">TransactionPending</span><span class="p">)</span>
     <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="bp">()</span>

  <span class="c1">// We return the model, and a list of Actions to execute</span>
  <span class="n">model'</span><span class="p">,</span> <span class="n">delayedCall</span> <span class="p">|&gt;</span> <span class="n">toActionList</span>

<span class="k">let</span> <span class="n">availableDiscounts</span> <span class="p">=</span>
  <span class="p">[</span> <span class="n">twelveItemsDiscount</span> <span class="p">]</span>

<span class="k">let</span> <span class="n">view</span> <span class="n">model</span> <span class="p">=</span>
  <span class="k">let</span> <span class="n">infoText</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">model</span><span class="p">.</span><span class="nc">Status</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Shopping</span> <span class="p">-&gt;</span> <span class="s2">"Please make your selection"</span>
    <span class="p">|</span> <span class="nc">TransactionPending</span> <span class="p">-&gt;</span> <span class="s2">"Waiting for confirmation from server"</span>
    <span class="p">|</span> <span class="nc">BuyingFailed</span> <span class="n">msg</span> <span class="p">-&gt;</span> <span class="s2">"Sorry, your purchase failed! The reason was: "</span> <span class="o">+</span> <span class="n">msg</span>
    <span class="p">|</span> <span class="nc">BuyingSucceeded</span> <span class="n">price</span> <span class="p">-&gt;</span> <span class="s2">"The purchase worked, with a final price of "</span> <span class="o">+</span> <span class="p">(</span><span class="n">price</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="p">)</span>

  <span class="k">let</span> <span class="n">counterView</span> <span class="n">quantity</span> <span class="p">=</span>
    <span class="n">div</span> <span class="bp">[]</span>
      <span class="p">[</span> <span class="n">label</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">text</span> <span class="p">(</span><span class="s2">"How many items do you want?"</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">button</span> <span class="p">[</span> <span class="n">onMouseClick</span> <span class="p">(</span><span class="k">fun</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="nc">IncreaseQuantity</span><span class="p">)</span> <span class="p">]</span> <span class="p">[</span> <span class="n">text</span> <span class="s2">"+"</span> <span class="p">]</span>
        <span class="n">label</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">text</span> <span class="p">(</span><span class="n">quantity</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">button</span> <span class="p">[</span> <span class="n">onMouseClick</span> <span class="p">(</span><span class="k">fun</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="nc">DecreaseQuantity</span><span class="p">)</span> <span class="p">]</span> <span class="p">[</span> <span class="n">text</span> <span class="s2">"-"</span> <span class="p">]</span>
      <span class="p">]</span>

  <span class="k">let</span> <span class="n">counters</span> <span class="p">=</span>
    <span class="p">[</span> <span class="n">counterView</span> <span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="nn">Cart</span><span class="p">.</span><span class="nc">Quantity</span><span class="p">)</span> <span class="p">]</span>

  <span class="k">let</span> <span class="n">applicableDiscounts</span> <span class="p">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">item</span> <span class="p">-&gt;</span> <span class="n">item</span><span class="p">.</span><span class="nc">Applies</span> <span class="n">model</span><span class="p">.</span><span class="nc">Cart</span> <span class="p">)</span> <span class="n">availableDiscounts</span>

  <span class="k">let</span> <span class="n">discountView</span> <span class="p">(</span><span class="n">discount</span> <span class="p">:</span> <span class="nc">Discount</span><span class="p">)</span> <span class="p">=</span>
    <span class="n">li</span> <span class="bp">[]</span>
      <span class="p">[</span> <span class="n">label</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">text</span> <span class="n">discount</span><span class="p">.</span><span class="nc">Name</span> <span class="p">]</span> <span class="p">]</span>

  <span class="k">let</span> <span class="n">discountsView</span> <span class="p">(</span><span class="n">discounts</span> <span class="p">:</span> <span class="nc">Discount</span> <span class="kt">list</span><span class="p">)</span> <span class="p">=</span>
    <span class="n">ul</span> <span class="p">[</span> <span class="n">classy</span> <span class="s2">"discounts"</span> <span class="p">]</span>
      <span class="p">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">discountView</span> <span class="n">discounts</span><span class="p">)</span>

  <span class="k">let</span> <span class="n">totalPrice</span> <span class="p">=</span>
    <span class="n">div</span> <span class="bp">[]</span> <span class="p">[</span> <span class="n">text</span> <span class="p">&lt;|</span> <span class="s2">"The total price is: "</span> <span class="o">+</span> <span class="o">((</span><span class="n">calculatePrice</span> <span class="n">availableDiscounts</span> <span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="nc">Cart</span><span class="o">)).</span><span class="nc">ToString</span><span class="bp">()</span><span class="p">)</span> <span class="p">]</span>

  <span class="n">div</span>
    <span class="bp">[]</span>
    <span class="p">[</span>
      <span class="n">label</span>
        <span class="bp">[]</span>
        <span class="p">[</span><span class="n">text</span> <span class="s2">"This is your shopping cart: "</span><span class="p">]</span>
      <span class="n">div</span>
        <span class="bp">[]</span>
        <span class="p">[</span> <span class="n">text</span> <span class="n">infoText</span> <span class="p">]</span>
      <span class="n">br</span> <span class="bp">[]</span>
      <span class="n">div</span> <span class="bp">[]</span> <span class="n">counters</span>
      <span class="n">discountsView</span> <span class="n">applicableDiscounts</span>
      <span class="n">totalPrice</span>
      <span class="n">button</span>
        <span class="p">[</span> <span class="n">onMouseClick</span> <span class="p">(</span><span class="k">fun</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="nc">Buy</span><span class="p">)</span>
          <span class="n">classy</span> <span class="s2">"buy"</span>
        <span class="p">]</span>
        <span class="p">[</span> <span class="n">i</span> <span class="p">[</span> <span class="n">classy</span> <span class="s2">"fa fa-bolt"</span> <span class="p">]</span> <span class="bp">[]</span>
          <span class="n">text</span> <span class="s2">" Buy!"</span>
        <span class="p">]</span>
    <span class="p">]</span>

<span class="c1">/// Create our application</span>
<span class="n">createApp</span> <span class="n">initModel</span> <span class="n">view</span> <span class="n">update</span> <span class="nn">Virtualdom</span><span class="p">.</span><span class="n">createRender</span>
<span class="p">|&gt;</span> <span class="n">withStartNodeSelector</span> <span class="s2">"#echo"</span>
<span class="p">|&gt;</span> <span class="n">start</span>

</code></pre></div></div>

<p>And finally the server code using Suave:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">open</span> <span class="nc">Suave</span>                 <span class="c1">// always open suave</span>
<span class="k">open</span> <span class="nn">Suave</span><span class="p">.</span><span class="nc">Web</span>             <span class="c1">// for config</span>
<span class="k">open</span> <span class="nn">Suave</span><span class="p">.</span><span class="nc">Writers</span>
<span class="k">open</span> <span class="nn">Suave</span><span class="p">.</span><span class="nc">Filters</span>
<span class="k">open</span> <span class="nn">Suave</span><span class="p">.</span><span class="nc">Successful</span>
<span class="k">open</span> <span class="nn">Suave</span><span class="p">.</span><span class="nc">Operators</span>
<span class="k">open</span> <span class="nn">Newtonsoft</span><span class="p">.</span><span class="nc">Json</span>
<span class="k">open</span> <span class="nn">FSharp</span><span class="p">.</span><span class="nc">Core</span>
<span class="k">open</span> <span class="nn">DiscountSample</span><span class="p">.</span><span class="nc">Shared</span>


<span class="k">type</span> <span class="nc">Error</span> <span class="p">=</span>
  <span class="p">{</span> <span class="nc">Error</span> <span class="p">:</span> <span class="kt">string</span>
  <span class="p">}</span>

<span class="k">let</span> <span class="n">discounts</span> <span class="p">=</span> <span class="p">[</span> <span class="n">twelveItemsDiscount</span> <span class="p">]</span>

<span class="k">let</span> <span class="n">serializeJson</span> <span class="n">obj</span> <span class="p">=</span>
  <span class="k">let</span> <span class="n">converter</span> <span class="p">=</span> <span class="k">new</span> <span class="nn">Fable</span><span class="p">.</span><span class="nc">JsonConverter</span><span class="bp">()</span>
  <span class="nn">JsonConvert</span><span class="p">.</span><span class="nc">SerializeObject</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span>

<span class="k">let</span> <span class="n">deserializeCart</span> <span class="n">str</span> <span class="p">=</span>
  <span class="k">let</span> <span class="n">converter</span> <span class="p">=</span> <span class="k">new</span> <span class="nn">Fable</span><span class="p">.</span><span class="nc">JsonConverter</span><span class="bp">()</span>
  <span class="k">let</span> <span class="n">deserialized</span> <span class="p">=</span> <span class="nn">JsonConvert</span><span class="p">.</span><span class="nc">DeserializeObject</span><span class="p">&lt;</span><span class="nc">Cart</span><span class="o">&gt;(</span><span class="n">str</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">boxed</span> <span class="p">=</span> <span class="n">box</span> <span class="n">deserialized</span>
  <span class="k">match</span> <span class="n">boxed</span> <span class="k">with</span>
    <span class="p">|</span> <span class="k">null</span> <span class="p">-&gt;</span>
      <span class="nc">None</span>
    <span class="p">|</span> <span class="n">other</span> <span class="p">-&gt;</span>
      <span class="nc">Some</span> <span class="n">deserialized</span>


<span class="k">let</span> <span class="n">deserializeCalculateSerialize</span> <span class="n">json</span> <span class="p">=</span>
  <span class="k">let</span> <span class="n">deserialized</span> <span class="p">=</span>
    <span class="n">json</span>
    <span class="p">|&gt;</span> <span class="n">deserializeCart</span>

  <span class="k">match</span> <span class="n">deserialized</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="n">cart</span> <span class="p">-&gt;</span>
      <span class="n">cart</span>
        <span class="p">|&gt;</span> <span class="n">calculatePrice</span> <span class="n">discounts</span>
        <span class="p">|&gt;</span> <span class="n">serializeJson</span>

    <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span>
      <span class="p">{</span> <span class="nc">Error</span> <span class="p">=</span> <span class="s2">"Could not deserialize"</span> <span class="p">}</span>
      <span class="p">|&gt;</span> <span class="n">serializeJson</span>

<span class="k">let</span> <span class="n">mapJson</span> <span class="n">f</span> <span class="p">=</span>
  <span class="n">request</span><span class="p">(</span><span class="k">fun</span> <span class="n">r</span> <span class="p">-&gt;</span>
    <span class="nn">System</span><span class="p">.</span><span class="nn">Text</span><span class="p">.</span><span class="nn">Encoding</span><span class="p">.</span><span class="nn">UTF8</span><span class="p">.</span><span class="nc">GetString</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">rawForm</span><span class="p">)</span>
    <span class="p">|&gt;</span> <span class="n">f</span>
    <span class="p">|&gt;</span> <span class="nn">Successful</span><span class="p">.</span><span class="nc">OK</span><span class="p">)</span>

<span class="k">let</span> <span class="n">setCORSHeaders</span> <span class="p">=</span>
    <span class="n">setHeader</span>  <span class="s2">"Access-Control-Allow-Origin"</span> <span class="s2">"*"</span>
    <span class="o">&gt;=&gt;</span> <span class="n">setHeader</span> <span class="s2">"Access-Control-Allow-Headers"</span> <span class="s2">"content-type"</span>

<span class="k">let</span> <span class="n">allow_cors</span> <span class="p">:</span> <span class="nc">WebPart</span> <span class="p">=</span>
    <span class="n">choose</span> <span class="p">[</span>
        <span class="nc">OPTIONS</span> <span class="o">&gt;=&gt;</span>
            <span class="k">fun</span> <span class="n">context</span> <span class="p">-&gt;</span>
                <span class="n">context</span> <span class="p">|&gt;</span> <span class="p">(</span>
                    <span class="n">setCORSHeaders</span>
                    <span class="o">&gt;=&gt;</span> <span class="nc">OK</span> <span class="s2">"CORS approved"</span> <span class="p">)</span>
    <span class="p">]</span>

<span class="k">let</span> <span class="n">app</span> <span class="p">=</span>
  <span class="n">choose</span> <span class="p">[</span>
    <span class="n">allow_cors</span>
    <span class="nc">POST</span> <span class="o">&gt;=&gt;</span> <span class="n">path</span> <span class="s2">"/test"</span> <span class="o">&gt;=&gt;</span> <span class="p">(</span><span class="n">mapJson</span> <span class="n">deserializeCalculateSerialize</span><span class="p">)</span> <span class="o">&gt;=&gt;</span> <span class="nn">Writers</span><span class="p">.</span><span class="n">setMimeType</span> <span class="s2">"application/json"</span>
  <span class="p">]</span>

<span class="n">startWebServer</span> <span class="n">defaultConfig</span> <span class="n">app</span>
</code></pre></div></div>

<h3 id="final-thoughts">Final thoughts</h3>

<p>I think that the ability to use F# on the backend with the full power of the .NET ecosystem but now also share code that does not depend on .NET libraries (like business logic and the core problem domain code) with the frontend is a very exiting development. I’m looking forward to exploring this in more detail in the future :).</p>

<p>I’d also be interested in hearing about people who already use this stack or are exploring one of the other options on using the same language on the frontend and the backend.</p>

<p>Finally I’d like to thank the numerous great people in the F# universe who keep improving this ecosystem and create examples and blogposts about them - to name just a few that I learned from the most about F#: <a href="https://github.com/tpetricek">Tomas Petricek</a>, <a href="https://fsharpforfunandprofit.com/">Scott Wlaschin</a>, <a href="https://github.com/alfonsogarciacaro">Alfonso Garcia Caro</a>, <a href="https://github.com/forki">Steffen Forkmann</a> and <a href="https://sergeytihon.wordpress.com/">Sergey Tihon</a>!</p>

        </div>
    </article>
    
    <article>
        <h1><a href="/2016/02/26/ports-in-elm.html">Ports in Elm</a></h1>
        <p class="author">
          <span class="date">26 February 2016</span>
        </p>
        <div class="content">
          <p>(Disclaimer: This post was written about Elm 0.16. Signals, the mechanism described in this post, have since been deprecated. The concepts in this post may still help understand how the Elm Architecture works internally, but the actual code has changed significantly)</p>

<p>This is the third post in a series of posts about <a href="http://elm-lang.org/">Elm</a>. In my <a href="/2016/02/12/signals-in-elm.html">first post about Signals in Elm</a> I briefly mentioned ports. Since they are the only way to communicate with “native” Javascript, they certainly warrant a closer look. If you haven’t checked out the last post in this series on <a href="/2016/02/19/tasks-and-effects-in-elm.html">tasks and effects</a> I suggest you do that now as this post will build on these concepts.</p>

<p>So what are Ports, exactly? They are basically a way to send messages from Elm to native JS or from JS to Elm. They are defined in Elm with their own keyword, <code class="highlighter-rouge">port</code>. If a Port is defined to be of a Non-Signal type (e.g. <code class="highlighter-rouge">port initialUrl : String</code>) then it is a “one time” message (at init time of the Elm code), i.e. such ports can be used if you want to send initialization values from JS to Elm at init time (and never afterwards). More frequently it will be a <code class="highlighter-rouge">Signal</code> of some type (e.g. a <code class="highlighter-rouge">Signal String</code>). Ports can not send and receive values of any type but only a subset - the big two groups of values that can’t be used are functions and union types (Maybe is the only exception to this rule). All the details can be found on the <a href="http://elm-lang.org/guide/interop">elm guide page on interop</a>.</p>

<p>As a simple example, let’s create a pair of ports to send <code class="highlighter-rouge">String</code>s from Elm to Js, do something with it in native JS, and then send the <code class="highlighter-rouge">String</code>s back. One case where something like this might be useful would be to encrypt values using a native library (using one of the new Browser crypto APIs).</p>

<h3 id="outgoing-ports">Outgoing ports</h3>

<p>Since we want to send stuff several times, not just once, we need to declare both ports as <code class="highlighter-rouge">Signals</code>. Let’s start with the outgoing port and on the Elm side:</p>

<div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">port</span> <span class="n">requestEncryption</span> <span class="p">:</span> <span class="kt">Signal</span> <span class="kt">String</span>
<span class="k">port</span> <span class="n">requestEncryption</span> <span class="o">=</span>
  <span class="c1">-- how do we get a Signal here for the implementation?</span>
</code></pre></div></div>

<p>This is a simple outgoing port definition, but somehow we have to implement this port - we need a way to get a Signal that we can “trigger” in our elm app and that will be received on the JS side. Let’s see how the JS side will look like before coming back to Elm:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'root'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">myapp</span> <span class="o">=</span> <span class="nx">Elm</span><span class="p">.</span><span class="nx">embed</span><span class="p">(</span><span class="nx">Elm</span><span class="p">.</span><span class="nx">MyApp</span><span class="p">,</span> <span class="nx">div</span><span class="p">);</span>
<span class="nx">myapp</span><span class="p">.</span><span class="nx">ports</span><span class="p">.</span><span class="nx">requestEncryption</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">encryptString</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">encryptString</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// do something with the string, send it to be encrypted etc</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Pretty straigthforward. We use the <code class="highlighter-rouge">subscribe</code> method to register a callback that will be called with the <code class="highlighter-rouge">message</code> string value every time the Signal fires at the Elm side. Ok, but how do we finish implementing this on the Elm side?</p>

<p>There are two ways to do this - one is to create a new <code class="highlighter-rouge">Mailbox</code> and use <code class="highlighter-rouge">Effects</code> to send our messages, the other is to create a custom version of <code class="highlighter-rouge">StartApp</code> that returns an additional value for things to send to the port in <code class="highlighter-rouge">update</code>. I have implemented both attempts as gists, here is the <a href="https://gist.github.com/danyx23/e42ceedaccf0c4a556b8">one with the Mailbox</a> and once with a <a href="https://gist.github.com/danyx23/6004778b9322dc716373">modified StartApp</a>. For the rest of the blogpost I will refer to the first version since it works with the vanilla StartApp. Ok, let’s hook up the Mailbox:</p>

<div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">portRequestEncryptionMailbox</span> <span class="p">:</span> <span class="kt">Mailbox</span> <span class="kt">String</span>
<span class="n">portRequestEncryptionMailbox</span> <span class="o">=</span>
  <span class="n">mailbox</span> <span class="s">"</span><span class="s2">"</span>

<span class="k">port</span> <span class="n">requestEncryption</span> <span class="p">:</span> <span class="kt">Signal</span> <span class="kt">String</span>
<span class="k">port</span> <span class="n">requestEncryption</span> <span class="o">=</span>
  <span class="n">portRequestEncryptionMailbox</span><span class="o">.</span><span class="n">signal</span>
</code></pre></div></div>

<p>This initalizes the <code class="highlighter-rouge">Mailbox</code> and fills in the hole we had before - the Signal we use as a port will just be the <code class="highlighter-rouge">Signal</code> of our new <code class="highlighter-rouge">Mailbox</code>. But how do we actually send anything to this Mailbox? By creating an Effect, like so:</p>

<div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sendStringToBeEncrypted</span> <span class="p">:</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">Effects</span> <span class="kt">Action</span>
<span class="n">sendStringToBeEncrypted</span> <span class="n">clearText</span> <span class="o">=</span>
  <span class="kt">Signal</span><span class="o">.</span><span class="n">send</span> <span class="n">portRequestEncryptionMailbox</span><span class="o">.</span><span class="n">address</span> <span class="n">clearText</span>
  <span class="o">|&gt;</span> <span class="kt">Effects</span><span class="o">.</span><span class="n">task</span>
  <span class="o">|&gt;</span> <span class="kt">Effects</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="o">\</span><span class="n">_</span> <span class="o">-&gt;</span> <span class="kt">Noop</span><span class="p">)</span>

<span class="c1">-- and this is our update function that now returns a tuple of (Model, Effect):</span>
<span class="n">update</span> <span class="p">:</span> <span class="kt">Action</span> <span class="o">-&gt;</span> <span class="kt">Model</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="kt">Model</span><span class="o">,</span> <span class="kt">Effects</span> <span class="kt">Action</span><span class="p">)</span>
<span class="n">update</span> <span class="n">action</span> <span class="n">model</span> <span class="o">=</span>
  <span class="k">case</span> <span class="n">action</span> <span class="k">of</span>
    <span class="kt">TextChanged</span> <span class="n">text</span> <span class="o">-&gt;</span>
      <span class="p">(</span> <span class="p">{</span> <span class="n">model</span> <span class="o">|</span> <span class="n">clearText</span> <span class="o">=</span> <span class="n">text</span> <span class="p">}</span>
      <span class="o">,</span> <span class="n">sendStringToBeEncrypted</span> <span class="n">text</span> <span class="c1">-- create the Effect here</span>
      <span class="p">)</span>
    <span class="c1">-- other cases ...</span>
</code></pre></div></div>

<p>The last line in <code class="highlighter-rouge">sendStringToBeEncrypted</code> may be a bit confusing - what are we mapping there? Let’s take a look at the type of <code class="highlighter-rouge">Mailbox.send</code>:</p>

<div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">send</span> <span class="p">:</span> <span class="kt">Address</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">Task</span> <span class="n">x</span> <span class="p">()</span>
</code></pre></div></div>

<p>This means that the <code class="highlighter-rouge">success</code> type of the task we get back from send is <code class="highlighter-rouge">()</code> (aka Unit) which acts a bit similar to <code class="highlighter-rouge">void</code> in C like languages, i.e. it represents “no actual value”. Let me desugar <code class="highlighter-rouge">sendStringToBeEncrypted</code> so it is clearer what types we are working with:</p>

<div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sendStringToBeEncrypted</span> <span class="p">:</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">Effects</span> <span class="kt">Action</span>
<span class="n">sendStringToBeEncrypted</span> <span class="n">clearText</span> <span class="o">=</span>
  <span class="n">sendTask</span> <span class="p">:</span> <span class="kt">Task</span> <span class="n">x</span> <span class="p">()</span>
  <span class="n">sendTask</span> <span class="o">=</span> <span class="kt">Signal</span><span class="o">.</span><span class="n">send</span> <span class="n">portRequestEncryptionMailbox</span><span class="o">.</span><span class="n">address</span> <span class="n">clearText</span>

  <span class="n">effectOfUnit</span> <span class="p">:</span> <span class="kt">Effects</span> <span class="p">()</span>
  <span class="n">effectOfUnit</span> <span class="o">=</span> <span class="kt">Effects</span><span class="o">.</span><span class="n">task</span> <span class="n">sendTask</span>

  <span class="n">effectOfAction</span> <span class="p">:</span> <span class="kt">Effects</span> <span class="kt">Action</span>
  <span class="n">effectOfAction</span> <span class="o">=</span> <span class="kt">Effects</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="o">\</span><span class="n">_</span> <span class="o">-&gt;</span> <span class="kt">Noop</span><span class="p">)</span>
</code></pre></div></div>

<p>(Note that instead of first converting to <code class="highlighter-rouge">Effects ()</code> and then mapping that I could also have mapped the <code class="highlighter-rouge">Task x ()</code> to <code class="highlighter-rouge">Task x Action</code> and then converted the Task to Effects). This may still seem a bit weird but it may help to realize that in this particular case of sending a message to a mailbox we are explicitly not interested in an actual <code class="highlighter-rouge">Action</code> value. We are only interested in performing the side effect of sending the message and it will not have a reasonable “payload” that should be routed through update. But because of how <code class="highlighter-rouge">Effects</code> are typed in <code class="highlighter-rouge">StartApp</code>, we do need to have an <code class="highlighter-rouge">Effects Action</code> in the end and so we introduce a <code class="highlighter-rouge">Noop</code> value that explicitly does nothing when it is processed in <code class="highlighter-rouge">update</code>.</p>

<p>At this point it is important to remember that StartApp.start returns a record that contains a tasks field and this has to be wired to an outgoing port - if you don’t do this, the Tasks you create via Effects will never be executed by the runtime:</p>

<div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">app</span> <span class="o">=</span>
  <span class="kt">StartApp</span><span class="o">.</span><span class="n">start</span>
    <span class="p">{</span> <span class="n">init</span> <span class="o">=</span> <span class="n">init</span>
    <span class="o">,</span> <span class="n">update</span> <span class="o">=</span> <span class="n">update</span>
    <span class="o">,</span> <span class="n">view</span> <span class="o">=</span> <span class="n">view</span>
    <span class="o">,</span> <span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="p">}</span>

<span class="k">port</span> <span class="n">tasks</span> <span class="p">:</span> <span class="kt">Signal</span> <span class="p">(</span><span class="kt">Task</span><span class="o">.</span><span class="kt">Task</span> <span class="kt">Never</span> <span class="p">())</span>
<span class="k">port</span> <span class="n">tasks</span> <span class="o">=</span>
  <span class="n">app</span><span class="o">.</span><span class="n">tasks</span>
</code></pre></div></div>

<p>Ok great, this is the outgoing part of the ports - how about handling stuff that comes into our Elm program?</p>

<h3 id="incoming-ports">Incoming Ports</h3>

<p>Let’s start on the Javascript side. We will define an incoming port called <code class="highlighter-rouge">encryptionCompleted</code> on the Elm side, and here we see how to send messages to it from JS. (Note that this example simplifies the logic a little and immediately after receiving a message from the outgoing port it sends an encrypted value back to Elm via the incoming port - in practice encryptString would probably call an API that returns a promise and only when this is fullfilled call <code class="highlighter-rouge">send</code> to send a value back to Elm)</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'root'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">myapp</span> <span class="o">=</span> <span class="nx">Elm</span><span class="p">.</span><span class="nx">embed</span><span class="p">(</span><span class="nx">Elm</span><span class="p">.</span><span class="nx">MyApp</span><span class="p">,</span> <span class="nx">div</span><span class="p">,</span> <span class="p">{</span><span class="na">encryptionCompleted</span> <span class="p">:</span> <span class="s2">""</span><span class="p">});</span>
<span class="nx">myapp</span><span class="p">.</span><span class="nx">ports</span><span class="p">.</span><span class="nx">requestEncryption</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">encryptString</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">encryptString</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">encryptedMessage</span> <span class="o">=</span> <span class="s2">"Encypted: "</span> <span class="o">+</span> <span class="nx">message</span><span class="p">;</span> <span class="c1">// actually encypting the message is ommited</span>
    <span class="nx">myapp</span><span class="p">.</span><span class="nx">ports</span><span class="p">.</span><span class="nx">encryptionCompleted</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">encryptedMessage</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Note that I not only had to modify <code class="highlighter-rouge">encryptString</code> but also pass in an initial value at the time when we initialize Elm with the call to <code class="highlighter-rouge">Elm.embed</code>. The third parameter takes the initial value of every incoming Signal we define on the Elm side - it is required because <code class="highlighter-rouge">Signals</code> in Elm always need an initial value. Let’s add this incoming port on the Elm side to complete the example:</p>

<div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">port</span> <span class="n">encryptionCompleted</span> <span class="p">:</span> <span class="kt">Signal</span> <span class="kt">String</span>

</code></pre></div></div>

<p>Note that this time the port we have defined has no “implementation” in Elm. That is because, viewed from Elm, this is just an external input - a Signal we can use to trigger behaviour in our app. But how can we do that? How can we wire up this Signal into our <code class="highlighter-rouge">StartApp.start</code> call?</p>

<p>In the last post, when we switched from StartApp.Simple to StartApp, I mentioned <code class="highlighter-rouge">inputs</code>. <code class="highlighter-rouge">inputs</code> is a <code class="highlighter-rouge">List of (Signal of Action)</code>, i.e. Signals that fire <code class="highlighter-rouge">Actions</code> that will be combined with the Signal of the main mailbox that is administered by StartApp. So this is exactly what we want to have for this little program so it can react to the Signal that represents the port - the only thing that is missing is that we have defined <code class="highlighter-rouge">encryptionCompleted</code> as a <code class="highlighter-rouge">Signal of String</code> and we need a <code class="highlighter-rouge">Signal of Action</code> for inputs. Sounds like we need a map again:</p>

<div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">encryptedString</span> <span class="p">:</span> <span class="kt">Signal</span> <span class="kt">Action</span>
<span class="n">encryptedString</span> <span class="o">=</span>
  <span class="kt">Signal</span><span class="o">.</span><span class="n">map</span> <span class="kt">EncryptedValueReceived</span> <span class="n">encryptionCompleted</span>

<span class="n">app</span> <span class="o">=</span>
  <span class="kt">StartApp</span><span class="o">.</span><span class="n">start</span>
    <span class="p">{</span> <span class="n">init</span> <span class="o">=</span> <span class="p">(</span><span class="n">init</span><span class="o">,</span> <span class="kt">Effects</span><span class="o">.</span><span class="n">none</span><span class="p">)</span>
    <span class="o">,</span> <span class="n">view</span> <span class="o">=</span> <span class="n">view</span>
    <span class="o">,</span> <span class="n">update</span> <span class="o">=</span> <span class="n">update</span>
    <span class="o">,</span> <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span> <span class="n">encryptedString</span> <span class="p">]</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>And voilà! We have a <code class="highlighter-rouge">Signal of Actions</code> that we can put into the inputs part of start.</p>

<p>So just to recap, let’s go through the example again: Whenever the user enters text we process the <code class="highlighter-rouge">TextChanged</code> value in our <code class="highlighter-rouge">update</code> function and not only update the model but also create a new <code class="highlighter-rouge">Effects</code>. This is then returned by <code class="highlighter-rouge">update</code> and, because we wired the <code class="highlighter-rouge">tasks</code> part returned by <code class="highlighter-rouge">start</code> to an outgoing <code class="highlighter-rouge">port</code>, it is handed to the runtime. This leads, on the native JS side, to a call of <code class="highlighter-rouge">encryptString</code> (because this is the function we registered with <code class="highlighter-rouge">subscribe</code>). In it we pretended to do some encryption and then sent the value back with <code class="highlighter-rouge">encryptionCompleted.send</code> (again, you can send values at any time, it only happens in our example that we send one value back for every value we receive on the JS side). This <code class="highlighter-rouge">send</code> call leads the <code class="highlighter-rouge">encryptionCompleted</code> Signal to fire, with the string value we sent from the JS side. This is than <code class="highlighter-rouge">map</code>ped into an <code class="highlighter-rouge">Action</code> value, namely <code class="highlighter-rouge">EncryptedValueReceived</code>, and because this is hooked up to the inputs part of StartApp it triggers the same chain through <code class="highlighter-rouge">update</code> as any other events. In <code class="highlighter-rouge">update</code> we then handle processing of this <code class="highlighter-rouge">EncryptedValueReceived</code> value and the whole exercise is complete.</p>

<p>Thanks for reading through this long post! I hope it was useful and I appreciate any feedback you might have!</p>

        </div>
    </article>
    
    <article>
        <h1><a href="/2016/02/19/tasks-and-effects-in-elm.html">Tasks and Effects in Elm</a></h1>
        <p class="author">
          <span class="date">19 February 2016</span>
        </p>
        <div class="content">
          <p>(Disclaimer: This post was written about Elm 0.16. Signals have since been deprecated. The concepts in this post may still help understand how the Elm Architecture works internally, but the actual code has changed significantly)</p>

<p>This is the second post in a series on some of the concepts in <a href="http://elm-lang.org/">Elm</a> that might be a bit puzzling when you start out with Elm. In the <a href="/2016/02/12/signals-in-elm.html">last post about Signals in Elm</a> I wrote about Signals and how they are behind the scenes of <code class="highlighter-rouge">StartApp.Simple</code>. In this post I get into long running operations like XHRs (aka AJAX). There are two closely related types that are involved in this, <code class="highlighter-rouge">Tasks</code> and <code class="highlighter-rouge">Effects</code>, and the exact differences between can be confusing in the beginning. So let’s dive right in:</p>

<h3 id="tasks">Tasks</h3>

<p><code class="highlighter-rouge">Task</code> is the more basic type (it is defined in Core) and so let’s start with this one. A Task represents a long-running operation that can fail (with an error type) or succeed (with a success type). It’s type is thus:</p>

<div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">Task</span> <span class="n">errorType</span> <span class="n">successType</span>

<span class="c1">-- (or, as it is actually written in the library:)</span>

<span class="kt">Task</span> <span class="n">x</span> <span class="n">a</span>
</code></pre></div></div>

<p>There are only two values of <code class="highlighter-rouge">Task</code> you can create yourself in your code, without using a separate library. These two ways are two functions:</p>

<div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">succeed</span> <span class="p">:</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">Task</span> <span class="n">x</span> <span class="n">a</span>

<span class="c1">-- and</span>

<span class="n">fail</span> <span class="p">:</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="kt">Task</span> <span class="n">x</span> <span class="n">a</span>
</code></pre></div></div>

<p>These are ways to create task values without actually doing any long-running operations. This can be useful if you want to combine a long running task and a simple value in some way and process them further (you would then turn the simple value into a <code class="highlighter-rouge">Task</code> with <code class="highlighter-rouge">succeed</code>).</p>

<p>Most of the time you actually get in contact with tasks, these will be created for you by library functions that initialize the task so that it will perform some long running operation when the runtime executes it and handle the result of the operation according to Task semantics (I.e. that some native code will make sure to call fail or succed on the native representation of the task when the operation is finished).</p>

<p>Note that the operation doesn’t start right away! I said “when the runtime executes it”. In purely functional programming languages, inside the language you can never just perform a side effect (something that changes “the world” outside the internal state of your code), and sending an http request surely is a side effect in that sense. This is one of the big mental shifts from imperative programming, where you can always do this, to working with purely functional languages where you can’t.</p>

<p>So how does this actually work? The task you get back <em>represents</em> the long running action. When a library creates it for you, nothing “happens”, it just created a value (of type <code class="highlighter-rouge">Task</code>) that indicates what you would like to happen.</p>

<p>If you look at e.g. the implementation of <a href="https://github.com/evancz/elm-http/blob/3.0.0/src/Native/Http.js">the native part of the send function in http</a> you will see that a <code class="highlighter-rouge">Task</code> is created in native JS code by handing it a callback. This callback is what will get called when the runtime actually executes the task. This is when the actual XHR request is created and performed - only when the runtime executes this callback.</p>

<p>So how do you get the runtime to run this task? By passing it into an outgoing <code class="highlighter-rouge">port</code>. I will go into detail on ports in a later blogpost, but suffice to say that they are a way to send messages between “native” JS and Elm (called an incoming <code class="highlighter-rouge">port</code>) and from Elm to native JS (an outgoing <code class="highlighter-rouge">port</code>). The runtime has some special casing for Tasks that come to it via outgoing ports that make it execute the callback the Task represents.</p>

<p>When the long running native code is done, it will either call <code class="highlighter-rouge">succeed</code> or <code class="highlighter-rouge">fail</code> on the task. In most real life code that uses the Elm Architecture you will set up a “chain” of task processing that will lead to the the end result of the task execution being that a value of your <code class="highlighter-rouge">Action</code> type is routed back through your <code class="highlighter-rouge">update</code> function. This value of your <code class="highlighter-rouge">Action</code> type is the usually tagged with the result of the task (e.g. the decoded Json response of an XHR).</p>

<p>As a last piece of info before we have a look at Effects and how all of this actually looks in an example, let me just mention that Tasks can easily be chained togehter with <code class="highlighter-rouge">andThen</code>, much like promises in JS are chained together.</p>

<h3 id="effects">Effects</h3>

<p>On to <code class="highlighter-rouge">Effects</code>! If you look at the definition for <code class="highlighter-rouge">Effects</code> it’s pretty simple:</p>

<div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="kt">Effects</span> <span class="n">a</span>
    <span class="o">=</span> <span class="kt">Task</span> <span class="p">(</span><span class="kt">Task</span><span class="o">.</span><span class="kt">Task</span> <span class="kt">Never</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="kt">Tick</span> <span class="p">(</span><span class="kt">Time</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="kt">None</span>
    <span class="o">|</span> <span class="kt">Batch</span> <span class="p">(</span><span class="kt">List</span> <span class="p">(</span><span class="kt">Effects</span> <span class="n">a</span><span class="p">))</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">None</code> and <code class="highlighter-rouge">Batch</code> are helpers, so the basic things an Effect can represent are <code class="highlighter-rouge">Tasks</code> (with error type <code class="highlighter-rouge">Never</code>) and <code class="highlighter-rouge">Ticks</code>. The latter is used for animations if you want to do something at the next animation frame.</p>

<p>It’s very common to turn a <code class="highlighter-rouge">Task</code> into an <code class="highlighter-rouge">Effect</code>, whereas the inverse is usually only ever done by <code class="highlighter-rouge">StartApp</code>/the runtime.</p>

<p>Several libraries use <code class="highlighter-rouge">Task</code> to allow you to work with long running operations - <code class="highlighter-rouge">Http</code> is one, <code class="highlighter-rouge">elm-history</code> is another.</p>

<p>So how is this used? The <a href="https://github.com/evancz/elm-architecture-tutorial#example-5-random-gif-viewer">Elm Architecture example 5</a> uses this very central piece of code:</p>

<div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">getRandomGif</span> <span class="p">:</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">Effects</span> <span class="kt">Action</span>
<span class="n">getRandomGif</span> <span class="n">topic</span> <span class="o">=</span>
  <span class="kt">Http</span><span class="o">.</span><span class="n">get</span> <span class="n">decodeImageUrl</span> <span class="p">(</span><span class="n">randomUrl</span> <span class="n">topic</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="kt">Task</span><span class="o">.</span><span class="n">toMaybe</span>
    <span class="o">|&gt;</span> <span class="kt">Task</span><span class="o">.</span><span class="n">map</span> <span class="kt">NewGif</span>
    <span class="o">|&gt;</span> <span class="kt">Effects</span><span class="o">.</span><span class="n">task</span>
</code></pre></div></div>

<p>Let’s look at what it does. It starts with creating a task that represents the Http <code class="highlighter-rouge">get</code> operation and then builds a chain on top of this. I will deconstruct this from using the pipe operator to normal function calls with type annotations to hopefully explain what’s happening:</p>

<div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">getRandomGif</span> <span class="n">topic</span> <span class="o">=</span>
  <span class="n">getTaskWithError</span> <span class="p">:</span> <span class="kt">Task</span> <span class="kt">Http</span><span class="o">.</span><span class="kt">Error</span> <span class="kt">String</span>
  <span class="n">getTaskWithError</span> <span class="o">=</span> <span class="kt">Http</span><span class="o">.</span><span class="n">get</span> <span class="n">decodeImageUrl</span> <span class="p">(</span><span class="n">randomUrl</span> <span class="n">topic</span><span class="p">)</span>

  <span class="n">getTaskWithNoErrorAndMaybe</span> <span class="p">:</span> <span class="kt">Task</span> <span class="kt">Never</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="kt">String</span><span class="p">)</span>
  <span class="n">getTaskWithNoErrorAndMaybe</span> <span class="o">=</span> <span class="kt">Task</span><span class="o">.</span><span class="n">toMaybe</span> <span class="n">getTaskWithError</span>

  <span class="n">getTaskWithNoErrorAndAction</span> <span class="p">:</span> <span class="kt">Task</span> <span class="kt">Never</span> <span class="p">(</span><span class="kt">Action</span><span class="p">)</span>
  <span class="n">getTaskWithNoErrorAndAction</span> <span class="o">=</span> <span class="kt">Task</span><span class="o">.</span><span class="n">map</span> <span class="kt">NewGif</span> <span class="n">getTaskWithNoErrorAndMaybe</span>

  <span class="n">taskAsEffect</span> <span class="p">:</span> <span class="kt">Effects</span> <span class="kt">Action</span>
  <span class="kt">Effects</span><span class="o">.</span><span class="n">task</span> <span class="n">getTaskWithNoErrorAndAction</span>
</code></pre></div></div>

<p>So in the end, Effects in this case just wraps the Task for us. Because we used <code class="highlighter-rouge">toMaybe</code> and then mapped it to the <code class="highlighter-rouge">NewGif</code> type constructor function, this will result in an <code class="highlighter-rouge">Action</code> coming back to us via <code class="highlighter-rouge">update</code> when it is done that is either (<code class="highlighter-rouge">NewGif Nothing</code>) if the http request failed, or (<code class="highlighter-rouge">NewGif "some-url-here"</code>) if it succeeds. If you want to understand how this wiring happens I would suggest looking at the <a href="https://github.com/evancz/elm-effects/blob/master/src/Effects.elm">implementation</a> of Effects.</p>

<p>One thing that is worth looking at is the return type of the function: Effects Action. Effects has a type variable, just like for example List. So this is an Effects that deals with the Action type you define in your application - and this is the really neat part of how to make sure that you can deal with the result of the Task/Effect - the result will just be a value of your Action type!</p>

<p>At this point you may wonder: why have Effects at all? Aren’t they just weird wrappers for Tasks? Let’s quickly take a look again at how the Task case of the Effects type is defined:</p>

<div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="kt">Effects</span> <span class="n">a</span>
    <span class="o">=</span> <span class="kt">Task</span> <span class="p">(</span><span class="kt">Task</span><span class="o">.</span><span class="kt">Task</span> <span class="kt">Never</span> <span class="n">a</span><span class="p">)</span>
</code></pre></div></div>

<p>The way <code class="highlighter-rouge">StartApp</code> is typed, going via <code class="highlighter-rouge">Effects Action</code> constraints all <code class="highlighter-rouge">Tasks</code> to come back with <code class="highlighter-rouge">Actions</code> and have the error type <code class="highlighter-rouge">Never</code>. This is really nice because it means that you don’t have to handle different task types to different ports, but you set up “pipelines” of tasks to effects like with <code class="highlighter-rouge">getRandomGif</code> above and it will all work out in a typesafe manner that the result of your tasks will be sent back to your program’s <code class="highlighter-rouge">update</code> function as <code class="highlighter-rouge">Actions</code>.</p>

<p>Ok, so finally, remember I wrote something about having to send Tasks off to an outgoing port. I you don’t do this, the Tasks will never be executed! If you want to use Effects, the easiest way is to switch from StartApp.Simple to StartApp. This brings three minor changes with it:</p>

<ol>
  <li><code class="highlighter-rouge">start</code> no longer directly returns a Signal of Html but a record of 3 Signals: one for the html, one for the model, and, crucially for us, one of tasks.</li>
  <li>The <code class="highlighter-rouge">update</code> function now returns not just the <code class="highlighter-rouge">Model</code>, but a tuple of<code class="highlighter-rouge"> (Model, Effects Action)</code>. I.e. that every case in your update function will have to return both the changed model and an Effect (which will often be <code class="highlighter-rouge">Effects.none</code>)</li>
  <li><code class="highlighter-rouge">start</code> gets a fourth parameter, <code class="highlighter-rouge">inputs</code>, for incoming <code class="highlighter-rouge">Signals</code>.</li>
  <li>The tasks part of the record that is returned by <code class="highlighter-rouge">start</code> has to be handed to a port so that the <code class="highlighter-rouge">Tasks/Effects</code> are actually performed by the runtime like so:</li>
</ol>

<div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">app</span> <span class="o">=</span>
  <span class="kt">StartApp</span><span class="o">.</span><span class="n">start</span>
    <span class="p">{</span> <span class="n">init</span> <span class="o">=</span> <span class="n">init</span> <span class="s">"</span><span class="s2">funny cats"</span>
    <span class="o">,</span> <span class="n">update</span> <span class="o">=</span> <span class="n">update</span>
    <span class="o">,</span> <span class="n">view</span> <span class="o">=</span> <span class="n">view</span>
    <span class="o">,</span> <span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="p">}</span>


<span class="n">main</span> <span class="o">=</span>
  <span class="n">app</span><span class="o">.</span><span class="n">html</span>


<span class="k">port</span> <span class="n">tasks</span> <span class="p">:</span> <span class="kt">Signal</span> <span class="p">(</span><span class="kt">Task</span><span class="o">.</span><span class="kt">Task</span> <span class="kt">Never</span> <span class="p">())</span>
<span class="k">port</span> <span class="n">tasks</span> <span class="o">=</span>
  <span class="n">app</span><span class="o">.</span><span class="n">tasks</span>
</code></pre></div></div>

<p>Phew, this got a little long again, but I hope it helps a little to understand how Tasks/Effects work!</p>

        </div>
    </article>
    
    <article>
        <h1><a href="/2016/02/12/signals-in-elm.html">Signals in Elm</a></h1>
        <p class="author">
          <span class="date">12 February 2016</span>
        </p>
        <div class="content">
          <p>(Disclaimer: This post was written about Elm 0.16. Signals, the mechanism described in this post, have since been deprecated. The concepts in this post may still help understand how the Elm Architecture works internally, but the actual code has changed significantly)</p>

<p>I have rewritten a webapp from React/Redux to <a href="http://elm-lang.org/">Elm</a> over the last few weeks and am really enjoying the language so far. Elm is a compile to Javascript, purely functional language that was built specifically to create web UIs with it. It is inspired by several functional programming languages, especially Haskell and OCaml. I have participated in the Elm google group quite a bit lately and I noticed that even though the Elm docs are really good, there are some concepts that are a bit hard to understand and to differentiate from each other. I am therefore starting a mini-series of posts about different concepts in Elm. This first one is about Signals - and why you don’t see them much in many smaller Elm programs even though they are always there.</p>

<p>These blog posts assume that you already know a little bit about Elm, e.g. you have gone through the <a href="http://www.lambdacat.com/road-to-elm-index/">great primer “Road to Elm”</a> by Lambdacat and then studied the <a href="https://github.com/evancz/elm-architecture-tutorial">Elm Architecture Tutorials</a> a little. OTOH, if you already use Tasks and Ports extensively you will find most of this a bit boring :). If you already know about Signals, you may want to jump ahead to the next post about <a href="/2016/02/19/tasks-and-effects-in-elm.html">tasks and effects</a> or the one after that about <a href="/2016/02/26/ports-in-elm.html">ports</a></p>

<h3 id="what-are-signals">What are Signals?</h3>

<p>Elm uses a very nice unidirectional architecture for the flow of:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>displayed website ➞ user actions ➞ new application state ➞ displayed website
</code></pre></div></div>

<p>All the code you write in a typical Elm program comes together in just two pure functions: <code class="highlighter-rouge">update</code> and <code class="highlighter-rouge">view</code>. Update takes a user action and the previous application state and creates a new application state, and view takes an application state and renders it into a virtual dom representation (that then gets efficiently displayed by batching diffs to the DOM a la React). For more background on unidirectional UIs in general see André Staltz’ excellent blog post <a href="http://staltz.com/unidirectional-user-interface-architectures.html">Unidirectional User Interface Architectures</a></p>

<p>One of the key concepts in Elm is that of a Signal. A Signal is a value that can change over time. One of the conceptually simplest signals is the current time - every second the signal “fires” with the new time value (seconds passed since epoch or whatever). Another example could be the coordinates of the mouse cursor in the current window. When the mouse is still, no values are fired by the Signal - but whenever the user moves the mouse, new values are sent. (This is actually one of the examples at <a href="http://elm-lang.org/examples/mouse-position">elm-lang.org/examples</a>). Signals are a bit similar to EventEmmitters or Observables in Javascript - the key difference is that they exist for the entire lifetime of the program and always have an initial value.</p>

<p>Signals don’t provide any access to their history - they only provide the current value. But even a simple counter example needs to track the number of clicks that happened so far. Since Elm is a pure language with no mutable state, how do you keep track of the current click-count? We’ll come back to that question, but first let’s look at how <code class="highlighter-rouge">StartApp.Simple</code> works that you probably know from the <a href="https://github.com/evancz/elm-architecture-tutorial">Elm Architecture Tutorials</a>.</p>

<p>StartApp hides a bit of wiring from you, but I think it helps to understand how <code class="highlighter-rouge">StartApp.start</code> does its magic. What the <code class="highlighter-rouge">start</code> function does is hook up a <code class="highlighter-rouge">Mailbox</code> (something where messages go when you send them to the address e.g. in an onClick handler) so that they lead to a new html emmited to main. This is the heart of the unidirectional UI approach. The user clicks a button, this leads to a message being sent to the mailbox. The mailbox has a <code class="highlighter-rouge">Signal</code> that fires whenever a message is sent to it. This <code class="highlighter-rouge">Signal</code> is of your applications <code class="highlighter-rouge">Action</code> type, i.e. it fires <code class="highlighter-rouge">Action</code> values. Eventually this leads to a full cycle through your <code class="highlighter-rouge">update</code>/<code class="highlighter-rouge">view</code> functions and thus to a new version of your Virtual Dom.</p>

<p>Let’s look at the intermediary types more closely: we start with a <code class="highlighter-rouge">Signal of Actions</code>. This then gets turned into a <code class="highlighter-rouge">Signal of Models</code> (so everytime a new <code class="highlighter-rouge">Action</code> is fired this action value is run through <code class="highlighter-rouge">update</code> together with the last model state to get the new model state). This finally gets turned into a <code class="highlighter-rouge">Signal of Html</code> (whenever the <code class="highlighter-rouge">Signal of Model</code> fires, we run it through the <code class="highlighter-rouge">view</code> function to arrive at a new Html to display). This is then handed to <code class="highlighter-rouge">main</code> so that the Elm runtime can display it for us.</p>

<p>Note that when I wrote about the update function, I said “together with the last model state”. This brings us back to our question from above - how can you work with history or state in Elm? The answer is in the function called <code class="highlighter-rouge">Signal.foldp</code> (“fold from the past”). If you aren’t familiar with folds yet, they are another name for reduce functions (as in map/reduce). It logically reduces all the values from the entire history with a given function and returns the value - in our case it uses the inital Model and reduces all Actions that were sent to our program to arrive at a current Model. (the implementation actually just caches the last current value and works from there of course).</p>

<p>At this point, if you want to really dive into it, let’s look at how <a href="https://github.com/evancz/start-app">StartApp.Simple</a> is actually implemented (I added comments and type annotation to every named value)</p>

<div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start</span> <span class="p">:</span> <span class="kt">Config</span> <span class="n">model</span> <span class="n">action</span> <span class="o">-&gt;</span> <span class="kt">Signal</span> <span class="kt">Html</span>
<span class="n">start</span> <span class="n">config</span> <span class="o">=</span>
  <span class="k">let</span>
    <span class="c1">-- create the main Mailbox. It is of type "Mailbox (Maybe action)" and is</span>
    <span class="c1">-- initialized with an "empty" value of Nothing</span>
    <span class="n">actions</span> <span class="p">:</span> <span class="kt">Mailbox</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="n">action</span><span class="p">)</span>
    <span class="n">actions</span> <span class="o">=</span>
      <span class="kt">Signal</span><span class="o">.</span><span class="n">mailbox</span> <span class="kt">Nothing</span>

    <span class="c1">-- here the address is set up. Since the Mailbox is of Maybe action,</span>
    <span class="c1">-- everything that is sent to address is "wrapped" in the Just type</span>
    <span class="c1">-- constructor and forwarded to the Mailbox</span>
    <span class="n">address</span> <span class="p">:</span> <span class="kt">Address</span> <span class="n">action</span>
    <span class="n">address</span> <span class="o">=</span>
      <span class="kt">Signal</span><span class="o">.</span><span class="n">forwardTo</span> <span class="n">actions</span><span class="o">.</span><span class="n">address</span> <span class="kt">Just</span>

    <span class="c1">-- This local version of update just wraps config.update to</span>
    <span class="c1">-- take care of the Maybe part of the action that will be</span>
    <span class="c1">-- processed (so that the update function the user provides)</span>
    <span class="c1">-- can simply operate as Action -&gt; Model -&gt; Model)</span>
    <span class="n">update</span> <span class="p">:</span> <span class="kt">Maybe</span> <span class="n">action</span> <span class="o">-&gt;</span> <span class="n">model</span> <span class="o">-&gt;</span> <span class="n">model</span>
    <span class="n">update</span> <span class="n">maybeAction</span> <span class="n">model</span> <span class="o">=</span>
      <span class="k">case</span> <span class="n">maybeAction</span> <span class="k">of</span>
        <span class="kt">Just</span> <span class="n">action</span> <span class="o">-&gt;</span>
            <span class="n">config</span><span class="o">.</span><span class="n">update</span> <span class="n">action</span> <span class="n">model</span>

        <span class="kt">Nothing</span> <span class="o">-&gt;</span>
            <span class="kt">Debug</span><span class="o">.</span><span class="n">crash</span> <span class="s">"</span><span class="s2">This should never happen."</span>

    <span class="c1">-- set up a signal of new models that foldp-s over</span>
    <span class="c1">-- the actions signal. This is the central piece</span>
    <span class="c1">-- that makes the elm architecture work the way it does.</span>
    <span class="c1">-- The update function will process one Action and</span>
    <span class="c1">-- the old Model state to the new model State, the</span>
    <span class="c1">-- Signal that triggers it all is the Mailbox' Signal</span>
    <span class="c1">-- we set up at the top</span>
    <span class="n">model</span> <span class="p">:</span> <span class="kt">Signal</span> <span class="n">model</span>
    <span class="n">model</span> <span class="o">=</span>
      <span class="kt">Signal</span><span class="o">.</span><span class="n">foldp</span> <span class="n">update</span> <span class="n">config</span><span class="o">.</span><span class="n">model</span> <span class="n">actions</span><span class="o">.</span><span class="n">signal</span>
  <span class="k">in</span>
    <span class="c1">-- Finally, map over it with the view function. This</span>
    <span class="c1">-- turns the Signal of Models into a Signal of Htmls</span>
    <span class="c1">-- that can be rendered</span>
    <span class="kt">Signal</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">view</span> <span class="n">address</span><span class="p">)</span> <span class="n">model</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">StartApp.Simple</code> is quite clever in how it uses a Signal under the hood but as a user who just wants to write some interactive web app you never need to deal with Signals directly and can just supply <code class="highlighter-rouge">update</code> and <code class="highlighter-rouge">view</code>. It all works fine until you need to message back and forth with native javascript. For that, you will need to use Ports, and understanding Signals first will be very helpful for that. The other thing StartApp.Simple does not let you do is perform long running operations, like e.g. send XHR requests.</p>

<p>The next post in the series deals with <a href="/2016/02/19/tasks-and-effects-in-elm.html">Tasks and Effects</a>, while the final post is all about <a href="/2016/02/26/ports-in-elm.html">ports</a>. I hope you enjoyed the article and if you have any feedback please let me know!</p>

        </div>
    </article>
    
    <article>
        <h1><a href="/2016/02/11/berlinjs-talk-about-elm.html">Slides for my talk about Elm at Berlin.js</a></h1>
        <p class="author">
          <span class="date">11 February 2016</span>
        </p>
        <div class="content">
          <p>Last month I had the oppertunity to talk about <a href="http://elm-lang.org/">Elm</a> at the very friendly <a href="http://berlinjs.org">Berlin.js</a> Javascript usergroup. If you don’t know about elm, it’s a pretty new, small language designed to create websites. The language is purely functional, nicely small, and modelled on Haskell and OCaml. Have a look at the slides if you are interested and follow the links on the third-to-last slide for more information! (If you use the arrow keys for navigating don’t miss the slides that extend downwards - or just use the spacebar to see all).</p>

<iframe src="//slides.com/danielbachler/fearless-refactoring-with-elm/embed" width="900" height="500" scrolling="no" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>

        </div>
    </article>
    

    <!-- Pagination links -->
    <div class="pagination">
      
      <a href="/" class="previous"><i class="fas fa-arrow-left"></i></a>
      
      <span class="page_number ">Page: 2 of 18</span>
      
      <a href="/page3" class="next"><i class="fas fa-arrow-right"></i></a>
      
    </div>

</div>

</article>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6822886-2', 'auto');
  ga('send', 'pageview');

</script>
</body>

</html>
